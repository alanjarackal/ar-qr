
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Lobby Demo</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://rawcdn.githack.com/AR-js-org/AR.js/3.3.2/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      #locationSelect, #distanceList, #toggleAR {
        position: absolute;
        left: 10px;
        right: 10px;
        z-index: 999;
        font-size: 14px;
      }
      #locationSelect { top: 10px; }
      #distanceList {
        bottom: 60px;
        max-height: 30%;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 10px;
      }
      #toggleAR {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: #00bcd4;
        color: white;
        border: none;
        border-radius: 8px;
      }
    </style>
  </head>
<body>
  <!-- AR Scene -->
  <a-scene embedded arjs="sourceType: webcam;">
    <!-- Marker for demonstration -->
    <a-marker preset="hiro">
      <a-box position="0 0.5 0" material="color: yellow;"></a-box>
    </a-marker>

    <!-- AR text element for displaying the selected location name -->
    <a-text id="arLocationText" value="" position="0 2 -3"></a-text>
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Dropdown for selecting current lobby location -->
  <select id="locationSelect">
    <option value="">Select Your Current Lobby Location</option>
  </select>
  <button id="toggleAR">Enter AR Mode</button>

  <!-- Display distances to other locations -->
  <div id="distanceList">
    <ul id="distanceUl"></ul>
  </div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://ikbwdlfjsxglfmydupsk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrYndkbGZqc3hnbGZteWR1cHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5MDg1NTUsImV4cCI6MjA1NjQ4NDU1NX0.NCc_38naVWc-JHO1qkcXdBU1BEqeZJfuxMrQwg07dD0';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let lobbyLocations = [];
    const toggleBtn = document.getElementById('toggleAR');
    let arVisible = true;

    toggleBtn.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      arVisible = !arVisible;
      scene.style.display = arVisible ? 'block' : 'none';
      toggleBtn.textContent = arVisible ? 'Exit AR Mode' : 'Enter AR Mode';
    });

    async function fetchLobbyLocations() {
      const { data, error } = await supabaseClient
        .from('points')
        .select('*')
        .eq('type', 'lobby');
      if (error) {
        console.error("Error fetching locations:", error);
        return;
      }
      lobbyLocations = data;
      populateLocationSelect(data);
    }

    function populateLocationSelect(locations) {
      const select = document.getElementById('locationSelect');
      locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = location.name;
        select.appendChild(option);
      });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = angle => angle * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function displayDistances(currentLocation) {
      const list = document.getElementById('distanceUl');
      list.innerHTML = "";
      lobbyLocations.forEach(location => {
        if (location.id == currentLocation.id) return;
        const d = calculateDistance(
          currentLocation.latitude, currentLocation.longitude,
          location.latitude, location.longitude
        );
        const li = document.createElement('li');
        li.textContent = `${location.name}: ${d.toFixed(1)} meters`;
        list.appendChild(li);
      });
    }

    function updateARText(text) {
      const arText = document.getElementById('arLocationText');
      arText.setAttribute('value', text);
    }

    function latLonToOffset(baseLat, baseLon, targetLat, targetLon) {
      const dx = (targetLon - baseLon) * 111320 * Math.cos(baseLat * Math.PI / 180);
      const dz = (targetLat - baseLat) * 110540;
      return { x: dx / 10, z: -dz / 10 };
    }

    function showARLabels(currentLocation) {
      const scene = document.querySelector('a-scene');
      document.querySelectorAll('.ar-label').forEach(e => e.remove());

      lobbyLocations.forEach(location => {
        if (location.id == currentLocation.id) return;
        const offset = latLonToOffset(
          currentLocation.latitude,
          currentLocation.longitude,
          location.latitude,
          location.longitude
        );
        const label = document.createElement('a-text');
        label.setAttribute('value', location.name);
        label.setAttribute('position', `${offset.x.toFixed(2)} 1.5 ${offset.z.toFixed(2)}`);
        label.setAttribute('color', 'yellow');
        label.setAttribute('look-at', '[camera]');
        label.setAttribute('class', 'ar-label');
        scene.appendChild(label);
      });
    }

    function handleLocationSelect(event) {
      const locationId = event.target.value;
      const currentLocation = lobbyLocations.find(loc => loc.id == locationId);
      if (!currentLocation) {
        document.getElementById('distanceUl').innerHTML = "";
        updateARText("");
        return;
      }

      updateARText(currentLocation.name);
      displayDistances(currentLocation);
      showARLabels(currentLocation);
    }

    document.getElementById('locationSelect').addEventListener('change', handleLocationSelect);

    fetchLobbyLocations();
  </script>
</body>
</html>
