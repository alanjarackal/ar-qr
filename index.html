
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Lobby Demo</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://rawcdn.githack.com/AR-js-org/AR.js/3.3.2/aframe/build/aframe-ar.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      #locationSelect, #distanceList, #toggleAR {
        position: absolute;
        left: 10px;
        right: 10px;
        z-index: 999;
        font-size: 14px;
      }
      #locationSelect { top: 10px; }
      #distanceList {
        bottom: 60px;
        max-height: 30%;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 10px;
      }
      #toggleAR {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: #00bcd4;
        color: white;
        border: none;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <select id="locationSelect">
      <option value="">Select your current location</option>
    </select>
    <div id="distanceList"></div>
    <button id="toggleAR">Exit AR Mode</button>

    <a-scene embedded arjs="sourceType: webcam;">
      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const supabaseUrl = "https://ikbwdlfjsxglfmydupsk.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrYndkbGZqc3hnbGZteWR1cHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5MDg1NTUsImV4cCI6MjA1NjQ4NDU1NX0.NCc_38naVWc-JHO1qkcXdBU1BEqeZJfuxMrQwg07dD0";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      let lobbyLocations = [];

      async function fetchLobbyLocations() {
        const { data, error } = await supabase.from("points").select("*").eq("type", "lobby");
        if (data) {
          lobbyLocations = data;
          populateLocationSelect();
        }
      }

      function populateLocationSelect() {
        const select = document.getElementById("locationSelect");
        lobbyLocations.forEach(loc => {
          const option = document.createElement("option");
          option.value = loc.id;
          option.textContent = loc.name;
          select.appendChild(option);
        });
      }

      function latLonToOffset(baseLat, baseLon, targetLat, targetLon) {
        const dx = (targetLon - baseLon) * 111320 * Math.cos(baseLat * Math.PI / 180);
        const dz = (targetLat - baseLat) * 110540;
        return { x: dx / 10, z: -dz / 10 };
      }

      function displayDistances(currentLocation) {
        const list = document.getElementById("distanceList");
        list.innerHTML = "";
        lobbyLocations.forEach(loc => {
          if (loc.id === currentLocation.id) return;
          const d = haversine(currentLocation.latitude, currentLocation.longitude, loc.latitude, loc.longitude);
          const div = document.createElement("div");
          div.textContent = `${loc.name}: ${d.toFixed(2)} m`;
          list.appendChild(div);
        });
      }

      function haversine(lat1, lon1, lat2, lon2) {
        function toRad(x) { return x * Math.PI / 180; }
        const R = 6371e3;
        const φ1 = toRad(lat1), φ2 = toRad(lat2);
        const Δφ = toRad(lat2 - lat1), Δλ = toRad(lon2 - lon1);
        const a = Math.sin(Δφ/2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      function showARLabels(currentLocation) {
        const scene = document.querySelector("a-scene");
        document.querySelectorAll(".ar-label").forEach(e => e.remove());

        lobbyLocations.forEach(location => {
          if (location.id === currentLocation.id) return;

          const offset = latLonToOffset(currentLocation.latitude, currentLocation.longitude, location.latitude, location.longitude);

          const label = document.createElement("a-entity");
          label.setAttribute("geometry", "primitive: plane; height: 0.3; width: auto");
          label.setAttribute("material", "color: black; opacity: 0.7");
          label.setAttribute("text", `value: ${location.name}; align: center; color: white;`);
          label.setAttribute("position", `${offset.x.toFixed(2)} 1.5 ${offset.z.toFixed(2)}`);
          label.setAttribute("look-at", "[camera]");
          label.setAttribute("class", "ar-label");
          scene.appendChild(label);
        });
      }

      document.getElementById("locationSelect").addEventListener("change", () => {
        const id = parseInt(document.getElementById("locationSelect").value);
        const selected = lobbyLocations.find(l => l.id === id);
        if (selected) {
          displayDistances(selected);
          showARLabels(selected);
        }
      });

      document.getElementById("toggleAR").addEventListener("click", () => {
        const scene = document.querySelector("a-scene");
        const btn = document.getElementById("toggleAR");
        const isVisible = scene.style.display !== "none";
        scene.style.display = isVisible ? "none" : "block";
        btn.textContent = isVisible ? "Enter AR Mode" : "Exit AR Mode";
      });

      fetchLobbyLocations();
    </script>
  </body>
</html>
