<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR Lobby Demo</title>

    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar.min.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
      body { margin: 0; overflow: hidden; font-family: sans-serif; }
      #locationSelect, #distanceList {
        position: absolute;
        left: 10px;
        right: 10px;
        z-index: 999;
        font-size: 14px;
      }
      #locationSelect { top: 10px; }
      #distanceList {
        bottom: 10px;
        max-height: 30%;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 10px;
      }
    </style>
  </head>

  <body>
    <!-- AR Scene -->
    <a-scene embedded arjs="sourceType: webcam;">
      <!-- Marker for demonstration -->
      <a-marker preset="hiro">
        <a-box position="0 0.5 0" material="color: yellow;"></a-box>
      </a-marker>
      <!-- AR text element for displaying the selected location name -->
      <a-text id="arLocationText" value="" position="0 2 -3"></a-text>
      <a-entity camera></a-entity>
    </a-scene>
    
    <!-- Dropdown for selecting current lobby location -->
    <select id="locationSelect">
      <option value="">Select Your Current Lobby Location</option>
    </select>
    <!-- Display distances to other locations -->
    <div id="distanceList">
      <ul id="distanceUl"></ul>
    </div>



      <!-- Dynamic AR Text -->
<!--       <a-entity id="arTextContainer"></a-entity> -->

    
    <!-- UI: Lobby Selector -->

    <!-- UI: Distance List -->

    <script>
      // Supabase setup
      const SUPABASE_URL = 'https://ikbwdlfjsxglfmydupsk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrYndkbGZqc3hnbGZteWR1cHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5MDg1NTUsImV4cCI6MjA1NjQ4NDU1NX0.NCc_38naVWc-JHO1qkcXdBU1BEqeZJfuxMrQwg07dD0'; // (Use your real key again here)
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let lobbyLocations = [];

      // Fetch lobby points from Supabase
      async function fetchLobbyLocations() {
        const { data, error } = await supabase
          .from('points')
          .select('*')
          .eq('type', 'lobby');

        if (error) {
          console.error("Error fetching locations:", error);
          return;
        }

        lobbyLocations = data;
        populateLocationSelect(data);
      }

      // Populate dropdown with lobbies
      function populateLocationSelect(locations) {
        const select = document.getElementById('locationSelect');
        locations.forEach(location => {
          const option = document.createElement('option');
          option.value = location.id;
          option.textContent = location.name;
          select.appendChild(option);
        });
      }

      // Simple distance calculation
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const toRad = deg => deg * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) ** 2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Show distances
      function displayDistances(currentLocation) {
        const list = document.getElementById('distanceUl');
        list.innerHTML = "";
        lobbyLocations.forEach(location => {
          if (location.id == currentLocation.id) return;
          const d = calculateDistance(
            currentLocation.latitude, currentLocation.longitude,
            location.latitude, location.longitude
          );
          const li = document.createElement('li');
          li.textContent = `${location.name}: ${d.toFixed(1)} meters`;
          list.appendChild(li);
        });
      }

      // AR Position offset calculator
      function latLonToOffset(baseLat, baseLon, targetLat, targetLon) {
        const dx = (targetLon - baseLon) * 111320 * Math.cos(baseLat * Math.PI / 180);
        const dz = (targetLat - baseLat) * 110540;
        return { x: dx / 10, z: -dz / 10 };
      }

      // Render AR labels for other lobbies
      function showARLabels(currentLocation) {
        const container = document.getElementById('arTextContainer');
        container.innerHTML = ''; // Clear existing

        lobbyLocations.forEach(location => {
          if (location.id == currentLocation.id) return;

          const offset = latLonToOffset(
            currentLocation.latitude,
            currentLocation.longitude,
            location.latitude,
            location.longitude
          );

          const text = document.createElement('a-text');
          text.setAttribute('value', location.name);
          text.setAttribute('position', `${offset.x.toFixed(2)} 1.5 ${offset.z.toFixed(2)}`);
          text.setAttribute('color', 'yellow');
          text.setAttribute('look-at', '[camera]');
          container.appendChild(text);
        });
      }

      function handleLocationSelect(event) {
        const locationId = event.target.value;
        const currentLocation = lobbyLocations.find(loc => loc.id == locationId);
        if (!currentLocation) {
          document.getElementById('distanceUl').innerHTML = "";
          return;
        }

        displayDistances(currentLocation);
        showARLabels(currentLocation);
      }

      // Event listeners
      document.getElementById('locationSelect').addEventListener('change', handleLocationSelect);

      // Init
      fetchLobbyLocations();
    </script>
  </body>
</html>
